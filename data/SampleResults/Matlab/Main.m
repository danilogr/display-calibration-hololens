%% Compute DICE and TRE metrics of scanned user trace compared to 
% scanned ground truth
% Mitchell Doughty
% December 2021

close all
clear all
clc

%% Draw coarse outline -> Right Click -> Copy position -> Paste below

% Make sure user-trace has been is scanned at 300 dpi
% 300 dpi, resize to 2550 x 3300
width = 3300;
height = 2550;

% trace
user_file = '..\Traces\calib_gt_02.jpg';
im = imresize(imread(user_file), [width, height]);

% truth, update to match "gt_xx" value
% gt_file = '..\Truths\GT_01.jpg';
gt_file = '..\Truths\GT_02.jpg';
% gt_file = '..\Truths\GT_03.jpg';
% gt_file = '..\Truths\GT_04.jpg';
% gt_file = '..\Truths\GT_05.jpg';
gt = imresize(imread(gt_file), [width, height]);

figure;
imshow(imfuse(im, gt,'blend','Scaling','joint'))
title('Alignment before registration');

%% Draw coarse outline outside of contour trace 
% roipoly(gt)

%% Outer mask
% GT 1
if (gt_file == '..\Truths\GT_01.jpg')
trace = [1688 1544;1304 1751;1079 2108;1004 2369;1322 2783;1829 2612;1985 2282;2111 1847;2030 1622; 1688 1544];
end

% GT 2
if (gt_file == '..\Truths\GT_02.jpg')
trace = [1349 1688;1000 1775;1000 1919;950 2084;1000 2400;1139 2500;1265 2600;1394 2600;1604 2495;1730 2441;1790 2360;1859 2240;1883 2117;1760 2003;1694 1871;1673 1763;1637 1652;1406 1664; 1349 1688];
end

% GT 3
if (gt_file == '..\Truths\GT_03.jpg')
trace = [1622 1544;1238 1559;1031 1736;968 2165;1190 2441;1376 2552;1694 2474;1820 2360;1928 2108;1886 1808;1742 1586; 1622 1544];
end

% GT 4
if (gt_file == '..\Truths\GT_04.jpg')
trace = [1380.99180327869 1597.75409836066;1224.10655737705 1670.7868852459;1148.36885245902 1811.44262295082;1113.20491803279 2019.72131147541;1194.35245901639 2200.95081967213;1232.22131147541 2403.81967213115;1283.61475409836 2482.26229508197;1397.22131147541 2517.4262295082;1554.10655737705 2503.90163934426;1721.81147540984 2422.75409836066;1830.00819672131 2252.34426229508;1927.38524590164 1981.85245901639;1930.09016393443 1673.49180327869;1867.87704918033 1565.29508196721;1673.12295081967 1546.36065573771; 1380.99180327869 1597.75409836066];
end

% GT 5
if (gt_file == '..\Truths\GT_05.jpg')
trace = [1484 1691;1271 1793;1181 1985;1178 2240;1211 2423;1283 2510;1424 2549;1646 2513;1745 2459;1763 2333;1847 2198;1913 2057;1910 1892;1850 1730;1658 1658; 1484 1691];
end

% GT 6
if (gt_file == '..\Truths\GT_06.jpg')
trace = [1274.10169491525 1607.15254237288;1159.4406779661 1629.52542372881;1067.15254237288 1800.1186440678;1025.20338983051 2085.37288135593;1075.54237288136 2253.16949152542;1170.62711864407 2379.01694915254;1223.76271186441 2532.83050847458;1293.6779661017 2599.94915254237;1467.06779661017 2616.72881355932;1682.40677966102 2535.62711864407;1799.86440677966 2395.79661016949;1813.84745762712 2261.5593220339;1791.47457627119 2127.32203389831;1749.52542372881 1970.71186440678;1746.72881355932 1839.27118644068;1682.40677966102 1657.49152542373;1439.10169491525 1609.94915254237; 1274.10169491525 1607.15254237288];
end

x = trace(:, 1);
y = trace(:, 2);

min_xy = min(trace);
max_xy = max(trace);

mask = poly2mask(x, y, size(gt, 1), size(gt, 2));

% Check the mask to make sure it looks OK
figure;
% imshow(mask)
imshow(gt)
hold on
plot(x,y,'b','LineWidth',2)
hold off

%% Draw coarse inside contour for points
% roipoly(gt)

%% Inner mask
% GT 1
if (gt_file == '..\Truths\GT_01.jpg')
trace_inner = [1634 1709;1577 1751;1520 1802;1466 1868;1457 1946;1475 2033;1520 2144;1511 2234;1457 2297;1322 2273;1268 2279;1259 2312;1271 2375;1304 2441;1355 2483;1442 2501;1523 2495;1595 2474;1667 2420;1766 2381;1793 2285;1856 2177;1889 2123;1907 2003;1916 1823;1904 1754;1838 1739;1715 1730; 1634 1709];
end

% GT 2
if (gt_file == '..\Truths\GT_02.jpg')
trace_inner = [1422.32203389831 1735.79661016949;1358 1774.94915254237;1279.69491525424 1788.93220338983;1268.50847457627 1797.32203389831;1285.28813559322 1861.64406779661;1338.42372881356 2018.25423728814;1366.38983050847 2085.37288135593;1344.01694915254 2090.96610169492;1310.45762711864 1998.6779661017;1246.13559322034 1850.45762711864;1201.38983050847 1870.03389830509;1176.22033898305 1925.96610169492;1151.05084745763 1981.89830508475;1134.27118644068 2051.81355932203;1123.08474576271 2104.94915254237;1159.4406779661 2194.4406779661;1165.03389830509 2269.94915254237;1193 2381.81355932203;1226.5593220339 2420.96610169492;1279.69491525424 2460.1186440678;1355.20338983051 2468.50847457627;1453.08474576271 2468.50847457627;1559.35593220339 2457.32203389831;1651.64406779661 2443.33898305085;1699.18644067797 2365.03389830509;1771.89830508475 2272.74576271186;1746.72881355932 2194.4406779661;1676.81355932203 2169.27118644068;1598.50847457627 2144.10169491525;1542.57627118644 2001.47457627119;1531.38983050847 1934.35593220339;1570.54237288136 1842.06779661017;1570.54237288136 1763.76271186441;1492.23728813559 1733; 1422.32203389831 1735.79661016949];
end

% GT 3
if (gt_file == '..\Truths\GT_03.jpg')
trace_inner = [1358 1703;1241 1700;1196 1748;1160 1871;1142 2018;1214 2186;1301 2387;1331 2501;1409 2516;1571 2471;1694 2363;1721 2192;1664 2018;1631 1814;1514 1712; 1358 1703];
end

% GT 4
if (gt_file == '..\Truths\GT_04.jpg')
trace_inner = [1513.53278688525 1673.49180327869;1383.69672131148 1762.75409836066;1307.95901639344 1816.85245901639;1234.9262295082 1865.54098360656;1224.10655737705 1930.45901639344;1245.74590163934 2019.72131147541;1310.66393442623 2090.04918032787;1335.00819672131 2233.40983606557;1321.48360655738 2333.49180327869;1329.59836065574 2411.93442622951;1364.76229508197 2449.80327868853;1443.20491803279 2425.45901639344;1562.22131147541 2390.29508196721;1648.77868852459 2390.29508196721;1719.10655737705 2263.16393442623;1808.36885245902 2079.22950819672;1854.35245901639 1979.14754098361;1857.05737704918 1849.31147540984;1832.7131147541 1684.31147540984;1748.86065573771 1676.19672131148;1651.48360655738 1662.67213114754;1575.74590163934 1638.32786885246; 1513.53278688525 1673.49180327869];
end

% GT 5
if (gt_file == '..\Truths\GT_05.jpg')
trace_inner = [1595 1742;1499 1811;1379 1856;1319 1871;1316 1994;1313 2171;1316 2264;1310 2345;1277 2384;1304 2459;1355 2489;1505 2462;1604 2465;1670 2438;1691 2345;1691 2219;1784 2171;1847 2081;1838 1922;1760 1793;1655 1724; 1595 1742];
end

% GT 6
if (gt_file == '..\Truths\GT_06.jpg')
trace_inner = [1358 1703;1241 1700;1196 1748;1160 1871;1142 2018;1214 2186;1301 2387;1331 2501;1409 2516;1571 2471;1694 2363;1721 2192;1664 2018;1631 1814;1514 1712; 1358 1703];
end


x_inner = trace_inner(:, 1);
y_inner = trace_inner(:, 2);

min_xy_inner = min(trace_inner);
max_xy_inner = max(trace_inner);

mask_inner = poly2mask(x_inner, y_inner, size(gt, 1), size(gt, 2));

% Check the mask to make sure it looks OK
figure;
% imshow(mask_inner)
imshow(gt)
hold on
plot(x_inner,y_inner,'b','LineWidth',2)
hold off


%% Make sure user-trace has been resized to 100 dpi, 850 x 1100 pixels, 
% read and register
% or 300 dpi, 2550 x 3300
% This can take a while depending on CPU 
im_gt = imresize(imread(gt_file), [width, height]);
im = imresize(imread(user_file), [width, height]);

% Register the images based on intensity to ground truth (static)
[im_reg_bw, im_gt_bw] = register_images(im, im_gt);

%% Check alignment accuracy
figure;
imshow(imfuse(im_reg_bw, im_gt_bw,'blend','Scaling','joint'))
title('Registration performance check');

%%
% Compute the TRE
tre = compute_tre(im_reg_bw, im_gt_bw, mask_inner, min_xy_inner, max_xy_inner, 8, 50, 5, 20);

% Convert from pixels to mm
% pixels per inch: 300, 1 inch = 25.4 mm
tre = (tre / 300) * 25.4
mean_tre = mean(tre)
std_tre = std(tre)
rms_tre = sqrt(mean_tre^2 + std_tre^2)

%%
% Compute the similarity
dsc = compute_similarity(im_reg_bw, im_gt_bw, mask, min_xy, max_xy)

%% 
% Compute the average symmetric surface distance metric (ASSD)
[ASSD_px, MSSD_px] = compute_assd(im_reg_bw, im_gt_bw, mask, min_xy, max_xy);

% Convert from pixels to mm
% pixels per inch: 300, 1 inch = 25.4 mm
ASSD = (ASSD_px / 300) * 25.4
MSSD = (MSSD_px / 300) * 25.4
